services:
  excavator:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        WORKSPACE: ${WORKSPACE:-/workspace}

    image: auwo_ros2:jazzy
    container_name: auwo_dev

    network_mode: host
    ipc: host
    runtime: nvidia

    volumes:
      # Host-edited code/config
      - ../src:${WORKSPACE:-/workspace}/src:rw
      - ../config:${WORKSPACE:-/workspace}/config:ro

      # Colcon artifacts (persistent, not in repo)
      - build_volume:${WORKSPACE:-/workspace}/build
      - install_volume:${WORKSPACE:-/workspace}/install
      - log_volume:${WORKSPACE:-/workspace}/log

      # ROS runtime data (persistent)
      - ros_home:/home/robot/.ros

      # RTAB-Map databases (persistent, separated)
      - rtabmap_db:/data/rtabmap

    environment:
      - DISPLAY=${DISPLAY:-}
      - QT_X11_NO_MITSHM=1
      - ROS_AUTOMATIC_DISCOVERY_RANGE=SUBNET
      - WORKSPACE=${WORKSPACE:-/workspace}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

    stdin_open: true
    tty: true

volumes:
  build_volume:
  install_volume:
  log_volume:
  ros_home:
  rtabmap_db:

